---
title: '错误处理'
description: '学习在Nuxt3中如何捕捉何处理错误'
navigation.icon: i-ph-bug-beetle-duotone
---

Nuxt 3 is a full-stack framework, which means there are several sources of unpreventable user runtime errors that can happen in different contexts:
Nuxt3 是一个全栈框架，意味着在不同环境下，将会有很多来源的无法预防的运行时错误，以下情况：
- Vue的客户端和服务渲染(SSR && CSR)中
- 服务端和客户端启动错误
- Nitro服务的生命周期中
- 下载JS组件失败




## Vue Errors
你可以通过onErrorCaputred，挂载到Vue错误
You can hook into Vue errors using [`onErrorCaptured`](https://vuejs.org/api/composition-api-lifecycle.html#onerrorcaptured).

另外，Nuxt提供vue:error钩子，它在任何错误被抛向顶部时被调用
In addition, Nuxt provides a [`vue:error`](/docs/api/advanced/hooks#app-hooks-runtime) hook that will be called if any errors propagate up to the top level.

如果你使用一个错误报告框架。你可以通过[`VueApp.config.errorHandle`](https://vuejs.org/api/application.html#app-config-errorhandler)提供一个全局的处理方法，即使这些错误已经被onErrorCaputred处理过了
<!-- If you are using an error reporting framework, you can provide a global handler through [`vueApp.config.errorHandler`]. It will receive all Vue errors, even if they are handled. -->

```ts twoslash [plugins/error-handler.ts]
export default defineNuxtPlugin((nuxtApp) => {
  nuxtApp.vueApp.config.errorHandler = (error, instance, info) => {
    // handle error, e.g. report to a service
  }

  // Also possible
  nuxtApp.hook('vue:error', (error, instance, info) => {
    // handle error, e.g. report to a service
  })
})
```

::note
`vue:error`钩子是一个基于onErrorCaptured的生命周期钩子
<!-- Note that the `vue:error` hook is based on [`onErrorCaptured`](https://vuejs.org/api/composition-api-lifecycle.html#onerrorcaptured) lifecycle hook. -->
::

## Startup Errors

在启动Nuxt应用阶段，如果产生错误，Nuxt会调用`app:error`钩子
<!-- Nuxt will call the `app:error` hook if there are any errors in starting your Nuxt application. -->

<!-- This includes: -->
包括：
- 运行 [Nuxt plugins](/docs/guide/directory-structure/plugins)
- 处理 `app:created` 和 `app:beforeMount` 钩子
- SSR阶段将你的Vue应用转换成HTML
<!-- rendering your Vue app to HTML (during SSR) -->
- 客户端挂载app(mounted)，尽管你使用了`onErrorCaptured` 或者`vue:error`
<!-- - mounting the app (on client-side), though you should handle this case with `onErrorCaptured` or with `vue:error` -->
<!-- - processing the `app:mounted` hook -->
- 处理`app:mounted`钩子

## Nitro Server Errors

<!-- You cannot currently define a server-side handler for these errors, but can render an error page, see the [Render an Error Page](#error-page) section. -->
你无法为这些错误，定义一个服务端回调，但是可以渲染一个错误页 [Render an Error Page](#error-page)

## Errors with JS chunks
你可以遭受chunk加载错误，当路径跳转的时候，Nuxt内置了对这种错误的处理（执行重新加载）
<!-- You might encounter chunk loading errors due to a network connectivity failure or a new deployment (which invalidates your old, hashed JS chunk URLs). Nuxt provides built-in support for handling chunk loading errors by performing a hard reload when a chunk fails to load during route navigation. -->

你可以改变这个行为，如果你希望自己处理，可以通过设置`experimental.emitRouteChunkError`为`false`或者`manual`[the automatic implementation](https://github.com/nuxt/nuxt/blob/main/packages/nuxt/src/app/plugins/chunk-reload.client.ts)
<!-- You can change this behavior by setting `experimental.emitRouteChunkError` to `false` (to disable hooking into these errors at all) or to `manual` if you want to handle them yourself. If you want to handle chunk loading errors manually, you can check out the [the automatic implementation](https://github.com/nuxt/nuxt/blob/main/packages/nuxt/src/app/plugins/chunk-reload.client.ts) for ideas. -->

## Error Page

::note
当Nuxt处理一个致命错误（服务端未处理的致命错误或者在客户端创建一个`fatal:true`的错误）。它会渲染一个JSON返回（如果请求中存在`Accept: application/json头部`）或者一个全屏错误页
<!-- When Nuxt encounters a fatal error (any unhandled error on the server, or an error created with `fatal: true` on the client) it will either render a JSON response (if requested with `Accept: application/json` header) or trigger a full-screen error page. -->
::

在服务端生命周期期间，错误可能出现，当：
<!-- An error may occur during the server lifecycle when: -->
- 处理你的Nuxt Plugins
<!-- - processing your Nuxt plugins -->
- 渲染你的Vue应用为HTML
<!-- - rendering your Vue app into HTML -->
- 服务端API抛出错误
<!-- - a server API route throws an error -->

也会在客户端出现错误，当：
<!-- It can also occur on the client side when: -->
- 处理你的Nuxt Plugins
<!-- - processing your Nuxt plugins -->
<!-- - before mounting the application (`app:beforeMount` hook) -->
- 在应用挂载前(`app:beforeMount`钩子)
<!-- - mounting your app if the error was not handled with `onErrorCaptured` or `vue:error` hook -->
- 在错误没有被`onErrorCaptured`或`vue:error`钩子处理时，挂载到你的app
<!-- - the Vue app is initialized and mounted in browser (`app:mounted`). -->
- 游览器中vue应用初始和挂载(mounted)的时候(`app:mounted`)

::read-more{to="/docs/api/advanced/hooks"}
发现更多Nuxt生命中区钩子
<!-- Discover all the Nuxt lifecycle hooks. -->
::

在代码根目录下（app.vue旁边）。添加`~/error.vue`来自定义默认的错误页
<!-- Customize the default error page by adding `~/error.vue` in the source directory of your application, alongside `app.vue`. -->

<!-- TODO:twoslash: Twoslash does not support tsconfig paths yet -->

```vue [error.vue]
<script setup lang="ts">
import type { NuxtError } from '#app'

const props = defineProps({
  error: Object as () => NuxtError
})

const handleError = () => clearError({ redirect: '/' })
</script>

<template>
  <div>
    <h2>{{ error.statusCode }}</h2>
    <button @click="handleError">Clear errors</button>
  </div>
</template>
```

::read-more{to="/docs/guide/directory-structure/error"}
读取更多信息`error.vue`
<!-- Read more about `error.vue` and its uses. -->
::

For custom errors we highly recommend to use `onErrorCaptured` composable that can be called in a page/component setup function or `vue:error` runtime nuxt hook that can be configured in a nuxt plugin.

我们非常推荐使用`onErrorCaptured`组合函数（page/component的setup方法或者`vue:error`钩子），来自定义错误

```ts twoslash [plugins/error-handler.ts]
export default defineNuxtPlugin(nuxtApp => {
  nuxtApp.hook('vue:error', (err) => {
    //
  })
})
```

<!-- When you are ready to remove the error page, you can call the [`clearError`](/docs/api/utils/clear-error) helper function, which takes an optional path to redirect to (for example, if you want to navigate to a 'safe' page). -->
当你打算移除错误页，你可以调用[`clearError`](/docs/api/utils/clear-error)方法，它接受一个附件路径，跳转到一个安全页面

::important
在Nuxt plugins，要做好对依赖检查（诸如`$route`或者`useRouter`），就像插件抛出错误一样，除非您清除错误，否则它不会重新运行
<!-- Make sure to check before using anything dependent on Nuxt plugins, such as `$route` or `useRouter`, as if a plugin threw an error, then it won't be re-run until you clear the error. -->
::

::note
If you are running on Node 16 and you set any cookies when rendering your error page, they will [overwrite cookies previously set](https://github.com/nuxt/nuxt/pull/20585). We recommend using a newer version of Node as Node 16 reached end-of-life in September 2023.
::

## Error Utils

### `useError`

```ts [TS Signature]
function useError (): Ref<Error | { url, statusCode, statusMessage, message, description, data }>
```

这方法会返回一个全局的被处理的Nuxt错误
<!-- This function will return the global Nuxt error that is being handled. -->

::read-more{to="/docs/api/composables/use-error"}
Read more about `useError` composable.
::

### `createError`

```ts [TS Signature]
function createError (err: { cause, data, message, name, stack, statusCode, statusMessage, fatal }): Error
```
用附件metadata创建一个错误对象。可以同时在app的服务端和Vue端使用，意味着需要搭配thrown使用
<!-- Create an error object with additional metadata. It is usable in both the Vue and Server portions of your app, and is meant to be thrown. -->
如果你抛出一个使用createError抛出错误
- 在服务端，它会触发一个满屏错误页（可以通过clearError移除）
- 在客户端，将为抛给你一个非致命错误来处理。如果你需要触发一个满屏页，你需要设置参数`fatal:true`
<!-- If you throw an error created with `createError`:
- on server-side, it will trigger a full-screen error page which you can clear with [`clearError`](#clearerror).
- on client-side, it will throw a non-fatal error for you to handle. If you need to trigger a full-screen error page, then you can do this by setting `fatal: true`. -->

```vue twoslash [pages/movies/[slug\\].vue]
<script setup lang="ts">
const route = useRoute()
const { data } = await useFetch(`/api/movies/${route.params.slug}`)

if (!data.value) {
  throw createError({
    statusCode: 404,
    statusMessage: 'Page Not Found'
  })
}
</script>
```

::read-more{to="/docs/api/utils/create-error"}
阅读更多关于`createError` 组件
<!-- Read more about `createError` util. -->
::

### `showError`

```ts [TS Signature]
function showError (err: string | Error | { statusCode, statusMessage }): Error
```
你可以调用这个方法在客户端的任何地方，或者在服务端的setup方法，middleware,plugins中直接调用。它会触发一个全屏的错误页
<!-- You can call this function at any point on client-side, or (on server side) directly within middleware, plugins or `setup()` functions. It will trigger a full-screen error page which you can clear with [`clearError`](#clearerror). -->

更建议使用`throw createError()`
<!-- It is recommended instead to use `throw createError()`. -->

::read-more{to="/docs/api/utils/show-error"}
Read more about `showError` util.
::

### `clearError`

```ts [TS Signature]
function clearError (options?: { redirect?: string }): Promise<void>
```

这个方法将清除当前处理的错误。它也接受一个路径用户重定向
<!-- This function will clear the currently handled Nuxt error. It also takes an optional path to redirect to (for example, if you want to navigate to a 'safe' page). -->

::read-more{to="/docs/api/utils/clear-error"}
Read more about `clearError` util.
::

## Render Error in Component
Nuxt也提供一个[`<NuxtErrorBoundary>`](/docs/api/components/nuxt-error-boundary)组件，允许你在app里处理客户端错误，而不是让整个页面显示错误
<!-- Nuxt also provides a [`<NuxtErrorBoundary>`](/docs/api/components/nuxt-error-boundary) component that allows you to handle client-side errors within your app, without replacing your entire site with an error page. -->

这个组件有责任处理错误，在客户端它会组件错误冒泡到顶层。而是渲染到`#error`插槽
<!-- This component is responsible for handling errors that occur within its default slot. On client-side, it will prevent the error from bubbling up to the top level, and will render the `#error` slot instead. -->

`#error`插槽将接受一个`error`参数做为参数。如果你设置error=null，它会触发默认插槽的重新渲染，所以你需要报这个错误解决了或者错误插槽在第二次加载中被渲染
<!-- The `#error` slot will receive `error` as a prop. (If you set `error = null` it will trigger re-rendering the default slot; you'll need to ensure that the error is fully resolved first or the error slot will just be rendered a second time.) -->

::tip
如果你导航到另一个路径，错误会被自动清理
<!-- If you navigate to another route, the error will be cleared automatically. -->
::

```vue [pages/index.vue]
<template>
  <!-- some content -->
  <NuxtErrorBoundary @error="someErrorLogger">
    <!-- You use the default slot to render your content -->
    <template #error="{ error, clearError }">
      You can display the error locally here: {{ error }}
      <button @click="clearError">
        This will clear the error.
      </button>
    </template>
  </NuxtErrorBoundary>
</template>
```

:link-example{to="/docs/examples/advanced/error-handling"}
